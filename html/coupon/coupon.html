<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.css" rel="stylesheet" />
		<style>
			html,body{
				touch-action: none;
				background-color: #EFF0F5;
			}
			header{
				display: flex;
				flex-direction: row;
				justify-content: center;
				align-items: center;
				background-color: red;
				height: 70px;
				box-shadow:0px 1px 5px #B6B6B6;
			}
				#segmented a{
					line-height: 25px;
					width: 30%;
					text-align: center;
			/* touch-action: none; */
				}
				.mui-segmented-control{
					border: none;
				}
					/** 设置 选项卡颜色，字体颜色 **/
			
			.mui-segmented-control .mui-control-item.mui-active {
				color: white;
				background-color: #5f75e0;
				font-weight: bold;
			}
			/** 设置 选项卡 高度（默认38px） **/
			
			.mui-segmented-control .mui-control-item {
				line-height: 38px;
				text-align: center;
				color: #007aff;
				border-color: #007aff;
				border-left: 1px solid #007aff;
				font-weight: bold;
			}
			
			
			#card{
				display: flex;
				flex-direction: row;
				justify-content: space-between;
				align-items: center;
				width: 100%;
			}
			#ss{
				display: flex;
				flex-direction: column;
				justify-content: space-around;
				align-items: center;
			}
		
		</style>
	</head>

	<body>
		<script src="../../js/mui.js"></script>
		<script src="../../js/environment.js"></script>
		<script type="text/javascript">
			mui.init({
				keyEventBind: {
					backbutton: false, //Boolean(默认true)关闭back按键监听
					menubutton: false //Boolean(默认true)关闭menu按键监听
				},
				preloadPages: [{
					id: 'generalCouponInfo.html',
					url: './generalCouponInfo.html'
				},
				{  
				    id:'customerCouponInfo.html',  
				    url:'./customerCouponInfo.html'
				}],
			})
			mui.plusReady(function() {


				var generalCouponInfo = null;
				//添加列表项的点击事件
				mui("#item2").on('tap', '.coupon', function() {
					
					//获取id
					var id = this.getAttribute("id")
					
					// 获得详情页面
					if (!generalCouponInfo) {
						generalCouponInfo = plus.webview.getWebviewById('generalCouponInfo.html')
					}
				
					//触发详情页面的couponId事件
					mui.fire(generalCouponInfo, 'couponId', {
						id: id
					});
					//打开详情页面          
					mui.openWindow({
						id: 'generalCouponInfo.html',
						url: './generalCouponInfo.html'
					});
				});
				
				var customerCouponInfo = null;
				//添加列表项的点击事件
				mui("#item1").on('tap', '.coupon', function() {
					
					//获取id
					var id = this.getAttribute("rewardCouponId")
					
					// 获得详情页面
					if (!customerCouponInfo) {
						customerCouponInfo = plus.webview.getWebviewById('customerCouponInfo.html')
					}
				
					//触发详情页面的couponId事件
					mui.fire(customerCouponInfo, 'couponId', {
						id: id
					});
					//打开详情页面          
					mui.openWindow({
						id: 'customerCouponInfo.html',
						url: './customerCouponInfo.html'
					});
				});


				mui('.mui-scroll-wrapper').scroll({
					scrollY: true, //是否竖向滚动
					scrollX: false, //是否横向滚动
					startX: 0, //初始化时滚动至x
					startY: 0, //初始化时滚动至y
					indicators: false, //是否显示滚动条
					deceleration: 0.0006, //阻尼系数,系数越小滑动越灵敏
					bounce: false //是否启用回弹
				});


				//不显示滚动条
				plus.webview.currentWebview().setStyle({
					scrollIndicator: 'none'
				});

				var customerId = plus.storage.getItem('customerId');
				getGeneralCouponList(1, 20);
				if (customerId != null) {
					getCustomerCouponList(customerId, 1, 20);
					document.getElementById('divContent').classList.remove('mui-hidden');
					document.getElementById('divLogin').classList.add('mui-hidden');
				} else {
					document.getElementById('divContent').classList.add('mui-hidden');
					document.getElementById('divLogin').classList.remove('mui-hidden');
				}

			})

			function getGeneralCouponList(pageNum, pageSize) {
				mui.ajax(baseUrl + 'coupon/general/list/' + pageNum + "/" + pageSize, {
					data: {

					},
					headers: {
						'Accept-Language': "en",
					},
					dataType: 'json',
					type: 'get',
					success: function(result) {
						if (result.code == 200) {
							var data = result.data;
							var item2 = document.getElementById('item2')
							var span = document.createElement('span')
							var img = document.createElement('img')
							if (data.list == []) {
								img.setAttribute('src', '../../img/nodata-search.png')
								span.innerText = 'No Coupons'
								item2.setAttribute('style',
									'display: flex;flex-direction: column;justify-content: center;align-items: center;font-weight: bold;margin-top: 100px;'
								)
								item2.appendChild(img)
								item2.appendChild(span)
							} else {
								notifiULList(data.list, "item2");
							}
						}

					}
				});

			}

			function getCustomerCouponList(customerId, pageNum, pageSize) {

				mui.ajax(baseUrl + 'customer/couponList/' + customerId + "/" + pageNum + "/" + pageSize, {
					data: {

					},
					headers: {
						'Accept-Language': "en",
						'Authentication': plus.storage.getItem('Authentication'),
					},
					dataType: 'json',
					type: 'get',
					success: function(result) {
						if (result.code == 200) {
							var data = result.data;
							var item1 = document.getElementById('item1')
							var span = document.createElement('span')
							var img = document.createElement('img')
							if (data.list == []) {
								img.setAttribute('src', '../../img/nodata-search.png')
								span.innerText = 'No Rewards'
								item1.setAttribute('style',
									'display: flex;flex-direction: column;justify-content: center;align-items: center;font-weight: bold;margin-top: 100px;'
								)
								item1.appendChild(img)
								item1.appendChild(span)
							} else {
								notifiULList(data.list, "item1");
							}

						}

					}
				});
			}

			function notifiULList(data, elm) {
				//plus.nativeUI.closeWaiting();
				var doc = document,
					fragment = doc.createDocumentFragment(),
					container = doc.getElementById(elm);
				//遍历数组
				mui.each(data, function(i, item) {
					notifiAndSetLiDetail(fragment, item, elm);
				});
				container.appendChild(fragment);
			}


			function notifiAndSetLiDetail(fragment, item, elm) {
				var div1 = document.createElement('div')
				var div2 = document.createElement('div')
				var p = document.createElement('p')
				var span1 = document.createElement('span')
				var span2 = document.createElement('span')
				var img = document.createElement('img')
				div2.setAttribute('id', 'card');
				div1.setAttribute('style', 'margin-bottom: 10px;background-color: #FFFFFF;padding: 5px;')
				img.setAttribute('style', 'width: 100px;height: 70px;margin-right: 6px;');
				span1.setAttribute('style', 'color: #D04431;font-weight: bold;');
				p.setAttribute('style', 'margin-top: 10px;font-size: 16px;color: #242424;margin-bottom: 20px;');
				span2.setAttribute('style', 'color: #888888;');

				if (elm == 'item1') {
					img.setAttribute('src', item.image);
					span1.innerText = item.title
					p.innerHTML = 'Member Offer: ' + item.description;
					span2.innerText = 'Expired date:' + item.expiryDate;
					
					div1.setAttribute('rewardCouponId', item.rewardCouponId);
					div1.setAttribute('class', 'coupon');
				} else {
					img.setAttribute('src', item.image);
					span1.innerText = item.titleEn
					p.innerHTML = 'Member Offer: ' + item.descriptionEn;
					span2.innerText = 'Expired date:' + item.endDate;
					//设置id,以便把id传到详情页
					div1.setAttribute('id', item.id);
					div1.setAttribute('class', 'coupon');
				}


				div1.appendChild(div2)
				div1.appendChild(p)
				div1.appendChild(span2)
				div2.appendChild(img)
				div2.appendChild(span1)
				fragment.appendChild(div1)
			}
			
			function toLogin() {
				var customerId = plus.storage.getItem('customerId');
				if (customerId == null)  {
					mui.openWindow({
						url: '../login/login.html',
						id: 'login.html'
					});
				}
			}
		</script>
		<header>
			<h1 style="color: #FFFFFF;font-weight: bold;font-size: 20px;">Coupons</h1>
		</header>

		<div class="mui-content" style="background-color: #EFF0F5;">

			<div id="divContent" class="mui-hidden">
			<div class="mui-content-padded" style="background-color: #EFF0F5;">
				<div class="mui-segmented-control">
					<a class="mui-control-item mui-active" href="#item1">My Rewards</a>
					<a class="mui-control-item" href="#item2">e-Coupons</a>
				</div>
			</div>

			<div class="mui-scroll-wrapper" style="margin-top: 130px;z-index: -1;background-color: #EFF0F5;">
				<div class="mui-scroll">
					<div id="item1" class="mui-control-content mui-active" style="width: 100%;">
					</div>
					<div id="item2" class="mui-control-content"></div>
				</div>
			</div>
			</div>
			<!-- 未登录状态  -->
			<div id="divLogin" class="mui-card mui-hidden" style="z-index: 10;margin: 220px 20px 20px 20px;border-radius: 20px;box-shadow: 0px 0px 0px #413D4A" onclick="toLogin()" >
				<div style="height: 80px;width: 100%;display: flex;flex-direction: row;justify-content: center;align-items: center;">
					<img src="../../img/nodata-search.png" style="width: 80px; height: 80px;border-radius: 80px;"/>
				</div>
				<div style="height: 80px;width: 100%;padding: 15px;display: flex;flex-direction: column;justify-content: center;align-items: center;">
					<div style="flex: 1;padding: 15px;">
						<span style="font-size: 20px;color: #6D6D72;font-weight: bold;">Login WingOn Reward</span>
					</div>
				</div>
				</div>
			</div>

			<div style="height: 70px;width: 70px;position: fixed;bottom: -56px;left: calc(50% - 35px);background: #EE5B5B;border-radius: 50%;z-index: 20;"></div>
		</div>
	</body>

</html>
