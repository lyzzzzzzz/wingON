<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.css" rel="stylesheet" />

		<style>
			html,body {
				height: 100%;
				width: 100%;
				padding: 0px;
				margin: 0px;
			}
			/* #btns{
				display: flex;
				flex-direction: row;
				justify-content: space-around;
				align-items: center;
				height: 100px;
				margin-bottom: 10px;
				width: 100%;
			} */
			.mui-content{
				display: flex;
				flex-direction: column;
				justify-content: space-around;
				align-items: center;
				width: 100%;
			}
		/* 	
			#btns button{
				width: 27%;height: 60%;
			} */
			#topContent{
				/* position: sticky; */
			    height: 100px;
				width: 100%;
				padding-top: 20px;
				background-color: red;
				padding-left: 10px;
				color: #FFFFFF;
			}
			header img{
				width: 45px;
				height: 45px;
			}
			.mui-slider img{
				width: 80%;
				height: 200px;
			}
			.mui-slider-item{
				width: 100%;
				height: 300;
				background-color: #FFFFFF
			}
		</style>


	</head>

	<body>
		<script src="../../js/mui.js"></script>
		<!-- <script src="../../js/mui.min.js"></script> -->
		<script src="../../js/environment.js"></script>
		<script type="text/javascript">
			mui.init({
				preloadPages: [{
					id: 'detail.html',
					url: './detail.html'
				}],
				keyEventBind: {
					backbutton: false, //Boolean(默认true)关闭back按键监听
					menubutton: false //Boolean(默认true)关闭menu按键监听
				},
				swipeBack: false
			})


			var first = null;
			var customerId = null;
			mui.plusReady(function() {

				customerId = plus.storage.getItem('customerId');
				if(customerId!=null){
					getCustomerInfo(customerId);
				}else{
					var userName = document.getElementById('userName');
					userName.innerHTML = '';
					
					var points = document.getElementById('points');
					points.innerHTML = 'Login';
					
					var pointsTips = document.getElementById('pointsTips');
					pointsTips.innerHTML = 'Reward App';
				}
				
				getNewsInfo();
				
				var detailPage = null;
				//添加列表项的点击事件
				mui(".mui-table-view").on('tap', 'li', function() {
					//获取id
					var id = this.getAttribute("id")
					// 获得详情页面
					if (!detailPage) {
						detailPage = plus.webview.getWebviewById('detail.html');
					}
					//触发详情页面的newsId事件
					mui.fire(detailPage, 'newsId', {
						id: id
					});
					//打开详情页面          
					mui.openWindow({
						id: 'detail.html',
						url: './detail.html'
					});
				});


			})


			function getCustomerInfo(customerId) {

				var url = baseUrl + '/customer/info/' + customerId;
				mui.ajax(url, {
					data: {

					},
					headers: {
						'Accept-Language': "en",
						'Authentication': plus.storage.getItem('Authentication'),
					},
					dataType: 'json',
					type: 'get',
					timeout: 10000,
					success: function(result) {
						if (result.code == 200) {
							var data = result.data;

							var accessToken = data.accessToken;
							if (accessToken.bearerToken == plus.storage.getItem('Authentication')) {
								var customer = data.customer;
								var address = data.address;
								var balanceVo = data.balanceVo;
								notifiUL(customer, address, balanceVo);
							} else {
								mui.toast("accessToken not match,login again");
								mui.openWindow({
									url: '../login/login.html',
									id: 'login.html'
								});
							}



						} else {
							mui.toast(result.msg);
						}

					},
					error: function(xhr, type, errorThrown) {
						mui.toast("error, type=" + type + " " + xhr);
					}
				});
			}

			function getNewsInfo() {
				mui.ajax(baseUrl + '/promotion/list/' + 1 + "/" + 2, {
					data: {

					},
					headers: {
						lang: "en"
					},
					dataType: 'json',
					type: 'get',
					success: function(result) {
						if (result.code == 200) {
							var data = result.data;
							notifiPromotionList(data.list);
						} else {
							mui.toast(result.msg);
						}

					}
				});
				mui.ajax(baseUrl + '/inbox/list/' + 1 + "/" + 5, {
					data: {

					},
					headers: {
						lang: "en"
					},
					dataType: 'json',
					type: 'get',
					success: function(result) {
						if (result.code == 200) {
							var data = result.data;
							notifiInboxList(data.list);
						} else {
							mui.toast(result.msg);
						}

					}
				});
			}


			function notifiUL(customer, address, balanceVo) {
				plus.nativeUI.closeWaiting();
				var userName = document.getElementById('userName');
				userName.innerHTML = 'Hi, ' + customer.firstName;

				var points = document.getElementById('points');
				points.innerHTML = balanceVo.balance;
				var pointsTips = document.getElementById('pointsTips');
				pointsTips.innerHTML = 'ePonit';
			}

			function notifiPromotionList(data) {
				plus.nativeUI.closeWaiting();
				var doc = document,
					fragment = doc.createDocumentFragment(),
					container = doc.getElementById("promotion");
				//遍历数组
				mui.each(data, function(i, item) {
					var doc = document,
						li = doc.createElement("li"),
						a = doc.createElement("a"),
						img = doc.createElement("img"),
						div = doc.createElement("div"),
						p = doc.createElement("p");
					li.setAttribute("class", "mui-table-view-cell mui-media");
					//把对象的ID赋给li的属性id,以便点击每个li的时候可以获取对象的id作为参数传到详情页,然后根据id查询
					li.setAttribute("id", item.id)
					img.setAttribute("style", "width: 100%;height: 160px;background-size: cover;")
					img.setAttribute("src", item.thumbnailImage);
					div.setAttribute("class", "mui-media-body");
					p.setAttribute("class", ".mui-ellipsis");
					p.setAttribute("style", "white-space: normal;")
					div.innerText = item.titleEn;
					p.innerHTML = item.descriptionEn;
					li.appendChild(a);
					a.appendChild(img);
					a.appendChild(div);
					div.appendChild(p);
					fragment.appendChild(li);
				});
				container.appendChild(fragment);
			}

			function notifiInboxList(data) {

				var doc = document,
					fragment = doc.createDocumentFragment(),
					container = doc.getElementById("slider-loop");
				//遍历数组
				for(var i = -1; i <= data.length; i++){
					var doc = document,
						li = doc.createElement("li"),
						a = doc.createElement("a"),
						img = doc.createElement("img"),
						div = doc.createElement("div"),
						p = doc.createElement("p");
					if(i==-1){
						li.setAttribute("class", "mui-slider-item mui-slider-item-duplicate");
						li.setAttribute("id", data[data.length-1].id)
						img.setAttribute("src", data[data.length-1].image);
						div.innerText = data[data.length-1].titleEn;
						p.innerHTML = data[data.length-1].subtitleEn;
						
					}else if(i== data.length){
						li.setAttribute("class", "mui-slider-item mui-slider-item-duplicate");
						li.setAttribute("id", data[0].id)
						img.setAttribute("src", data[0].image);
						div.innerText = data[0].titleEn;
						p.innerHTML = data[0].subtitleEn;
					}else{
						var item = data[i];
						li.setAttribute("class", "mui-slider-item");
						li.setAttribute("id", item.id)
						img.setAttribute("src", item.image);
						div.innerText = item.titleEn;
						p.innerHTML = item.subtitleEn;
					}
					img.setAttribute("style", "width: 100%;height: 160px;background-size: cover;")
					div.setAttribute("class", "mui-media-body");
					div.setAttribute("style", "margin-top:20px;");
					p.setAttribute("class", ".mui-ellipsis");
					p.setAttribute("style", "margin-top:20px;white-space: normal;")
					li.appendChild(a);
					a.appendChild(img);
					a.appendChild(div);
					div.appendChild(p);
					fragment.appendChild(li);
				}
				container.appendChild(fragment);
				
				//获得slider插件对象   轮播
				var gallery = mui('#slider');
				gallery.slider({
					interval: 3000 //自动轮播周期，若为0则不自动播放，默认为0；
				});
			}

			function toSetting() {
				mui.openWindow({
					url: './homeSet.html',
					id: 'homeSet.html'
				});
			}

			// function toReward() {
			//   mui.openWindow({
			//     url: './reward/reward.html',
			//     id: 'reward.html'
			//   });
			// }

			function toQRCode() {
				
				if(customerId!=null){
					mui.openWindow({
						url: './qrCode.html',
						id: 'qrCode.html'
					});
				}else{
					mui.openWindow({
						url: './login.html',
						id: 'login.html'
					});
				}
			}

			function toEPointBalance() {
				if(customerId!=null){
					mui.openWindow({
						url: './pointBalance.html',
						id: 'pointBalance.html'
					});
				}else{
					mui.openWindow({
						url: './login.html',
						id: 'login.html'
					});
				}
				
			}

			function toLocation() {
				mui.openWindow({
					url: './location.html',
					id: 'location.html'
				});
			}

			function toMessage() {
				
				if(customerId!=null){
					mui.openWindow({
						url: './message.html',
						id: 'message.html'
					});
				}else{
					mui.openWindow({
						url: './login.html',
						id: 'login.html'
					});
				}
			}
		</script>

		<header class="mui-bar mui-bar-nav" style="background-color: red;box-shadow: 0px 0px 0px #413D4A;">
			<img src="../../img/topbar_locator.png" class="mui-icon  mui-icon-bars" onclick="toLocation()" />
			<h1 class="mui-title" style="color: #FFFFFF;font-weight: bold;font-size: 20px;">WingOn Reward</h1>
			<img src="../../img/topbar_inbox.png" class="mui-pull-right mui-icon mui-icon-bars" onclick="toMessage()" />
			<img src="../../img/set.png" class="mui-pull-right mui-icon mui-icon-bars" onclick="toSetting()" style="margin-right: 5px;width: 41px;height: 41px;" />
		</header>

		<div class="mui-content">
			<div id="topContent">
				<div>
					<a style="font-size: 18px;color: #FFFFFF;" id="userName"></a>
					<!-- <span class="mui-icon mui-icon-forward" ></span> -->
				</div>
				
				<div style="margin-top:20px;touch-action: none;" onclick="toEPointBalance()">
					<a style="font-size: 20px;font-weight: bold;color: #FFFFFF;" id="points"></a>
					<a style="font-size: 20px;color: #FFFFFF;font-weight: bold;" id="pointsTips">ePoints </a>
					<span class="mui-icon mui-icon-forward"></span>
				</div>
			</div>

			<div style="margin-top: 1%;width: 100%;background-color: #FFFFFF;">
				<h4 style="margin-bottom: 3%;margin-left: 12px;">Lastest Offers</h4>

			<!-- 轮播 -->
			<div class="mui-slider" id="slider">
				<div class="mui-slider-group mui-slider-loop" id="slider-loop">

				</div>
			</div>
			</div>
			
			<div style="margin-top: 5%;width: 100%;background-color: #FFFFFF;">
				<h4 style="margin-bottom: 3%;margin-left: 12px;">Lastest Promotion</h4>
				<ul class="mui-table-view" id="promotion" style="margin-bottom: 5%;">
				</ul>
				<ul class="mui-table-view" id="inbox" style="margin-bottom: 5%;">
				</ul>

			</div>

			<div style="height: 70px;width: 70px;position: fixed;bottom: -56px;left: calc(50% - 35px);background: #EE5B5B;border-radius: 50%;"></div>

		</div>


	</body>
</html>
