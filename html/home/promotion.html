<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.css" rel="stylesheet" />
		<style type="text/css">
			html,
			body {
				margin: 0px;
				padding: 0px;
			}

			.mui-content {
				display: flex;
				flex-direction: column;
				align-items: center;
				width: 100%;
			}

			#ul {
				margin-top: 10px;
				margin-bottom: 10px;
			}
		</style>
	</head>

	<body>
		<script src="../../js/mui.js"></script>
		<script src="../../js/mui.pullToRefresh.js"></script>
		<script src="../../js/mui.pullToRefresh.material.js"></script>
		<script src="../../js/environment.js"></script>
		<script type="text/javascript">
			mui.init({
				keyEventBind: {
					backbutton: false, //Boolean(默认true)关闭back按键监听
					menubutton: false //Boolean(默认true)关闭menu按键监听
				},
				pullRefresh: {
					container: '#content', //待刷新区域标识，querySelector能定位的css选择器均可，比如：id、.class等
					up: {
						height: 50, //可选.默认50.触发上拉加载拖动距离
						auto: true, //可选,默认false.自动上拉加载一次
						contentrefresh: "正在加载...", //可选，正在加载状态时，上拉加载控件上显示的标题内容
						contentnomore: '没有更多数据了', //可选，请求完毕若没有更多数据时显示的提醒内容；
						callback: pullupRefresh //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
					}
				}



			})
			mui.plusReady(function() {
				//不显示滚动条
				plus.webview.currentWebview().setStyle({
					scrollIndicator: 'none'
				});

				// getPromotionInfo(1, 5);

				var detailPage = null;
				//添加列表项的点击事件
				mui(".mui-table-view").on('tap', 'li', function() {
					//获取id
					var id = this.getAttribute("id")
					// 获得详情页面
					if (!detailPage) {
						detailPage = plus.webview.getWebviewById('detail.html');
					}
					//触发详情页面的newsId事件
					mui.fire(detailPage, 'promotionId', {
						id: id
					});
					//打开详情页面          
					mui.openWindow({
						id: 'detail.html',
						url: './detail.html'
					});
				});
			})

			var pageStart = 0; //开始数据条数 
			var page = 1; //当前页
			var pageSize = 10; //每页显示条数  
			var isOver = false; //是否加载完 
		

			function pullupRefresh() {
				setTimeout(function() {
					mui('#content').pullRefresh().endPullupToRefresh((isOver)); //参数为true代表没有更多数据了。
					getPromotionInfo(page, pageSize)
				}, 1500);
			}



			function getPromotionInfo(pageNum, pageSize) {
				mui.ajax(baseUrl + '/promotion/list/' + pageNum + "/" + pageSize, {
					data: {

					},
					headers: {
						'Accept-Language': "en",
					},
					dataType: 'json',
					type: 'get',
					success: function(result) {
						if (result.code == 200) {
							var data = result.data;
							notifiULList(data.list);
						} else {
							mui.toast(result.msg);
						}

					}
				});
			}

			function notifiULList(data) {
				//plus.nativeUI.closeWaiting();
				var doc = document,
					fragment = doc.createDocumentFragment(),
					container = doc.getElementById("ul");

				if (data != []) {
					//遍历数组
					mui.each(data, function(i, item) {
						notifiAndSetLiDetail(fragment, item);
					});

					//判断是否还有数据,若小于每次加载条数,结束  
					if (data.length < pageSize) {
						isOver = true;
						mui('#content').pullRefresh().endPullupToRefresh(true); //停止下拉显示暂无数据
					}

					//每次加载结束之后，如果还有数据则++  
					if (isOver == false) {
						page++;
						mui('#content').pullRefresh().endPullupToRefresh(true);
						mui('#content').pullRefresh().enablePullupToRefresh();
						// setTimeout(nextRefresh, 1000); //停止正在加载
						//显示上拉加载文字
					}
					container.appendChild(fragment);
				} else {
					mui('#content').pullRefresh().endPullupToRefresh(true); //停止下拉显示暂无数据
				}
			}


			function notifiAndSetLiDetail(fragment, item) {
				var doc = document,
					li = doc.createElement("li"),
					a = doc.createElement("a"),
					img = doc.createElement("img"),
					div = doc.createElement("div"),
					p = doc.createElement("p");
				li.setAttribute("class", "mui-table-view-cell mui-media");
				li.setAttribute("id", item.id)
				img.setAttribute("style", "width: 100%;height: 200px;");
				img.setAttribute("src", item.thumbnailImage);
				div.setAttribute("class", "mui-media-body");
				p.setAttribute("class", "mui-ellipsis");
				p.setAttribute("style", "white-space: normal;")
				div.innerText = item.titleEn;
				p.innerHTML = item.descriptionEn;
				li.appendChild(a);
				a.appendChild(img);
				a.appendChild(div);
				div.appendChild(p);
				fragment.appendChild(li);
			}
		</script>
		<header class="mui-bar mui-bar-nav" style="background-color: red;box-shadow:0px 1px 5px #B6B6B6">
			<h1 class="mui-title" style="color: #FFFFFF;font-weight: bold;font-size: 20px;">Promotion</h1>
		</header>

		<div class="mui-content" id="content">
			<ul class="mui-table-view" id="ul" style="width: 95%;"></ul>
			<div style="height: 70px;width: 70px;position: fixed;bottom: -56px;left: calc(50% - 35px);background: #EE5B5B;border-radius: 50%;"></div>
		</div>

	</body>

</html>
